#!/usr/bin/env node

var parser        = require('../src/spec-parser'),
    fs            = require('fs'),
    commonmark    = require('commonmark'),
    child_process = require('child_process')

var reader = new commonmark.Parser(),
    writer = new commonmark.HtmlRenderer()

function renderCommonmark (source) {
  var parsed = reader.parse(source)
  return writer.render(parsed)
}

// Read the spec file
// var spec = fs.readFileSync(__dirname+'/../doc/specification.md').toString()
var specSource = child_process.execSync('git show master:doc/specification.md').toString()

var specs = parser.parseSpecification(specSource)
// console.log(specs)

var position = 0,
    parts    = [
      '---',
      'title: Specification',
      '---',
      '<div class="specification page">',
      '<!-- Don\'t edit me! I was generated automagically by bin/compile-spec. -->'
    ];

specs.forEach(function (spec) {
  var before = specSource.substring(position, spec.start)
  parts.push(renderCommonmark(before))

  // Add the spec pieces
  var hb = '<div class="spec hb" spec-type="Hummingbird"><pre><code class="lang-typescript">'+spec.hb+'</code></pre></div>'
  var js = '<div class="spec js" spec-type="JavaScript"><pre><code class="lang-js">'+spec.js+'</code></pre></div>'
  parts.push('<div class="spec-pair">')
  parts.push(hb)
  parts.push(js)
  parts.push('</div>')

  position = spec.end
})
// Add anything after the last spec
var after = specSource.substring(position, specSource.length)
parts.push(renderCommonmark(after))
parts.push("</div>\n")

// console.log(parts.join("\n"))

fs.writeFileSync(__dirname+'/../specification.html', parts.join("\n"))
