#!/usr/bin/env node

var parser        = require('../lib/spec-parser'),
    fs            = require('fs'),
    commonmark    = require('commonmark'),
    child_process = require('child_process')

var reader = new commonmark.Parser(),
    writer = new commonmark.HtmlRenderer()

function renderCommonmark (source) {
  var parsed = reader.parse(source)
  return writer.render(parsed)
}

// Read the spec file
// var spec = fs.readFileSync(__dirname+'/../doc/specification.md').toString()
var specSource = child_process.execSync('git show spec:doc/Specification.md').toString()

var specs = parser.parseSpecification(specSource)
// console.log(specs)

var position = 0,
    parts    = ['<!-- Don\'t edit me! I was generated automagically by bin/compile-spec. -->'];

specs.forEach(function (spec) {
  var before = specSource.substring(position, spec.start)
  parts.push(renderCommonmark(before))
  
  // Add the spec pieces
  var js = '<div class="spec js"><code><pre>'+spec.js+'</pre></code>'
  var hb = '<div class="spec hb"><code><pre>'+spec.hb+'</pre></code>'
  parts.push(js)
  parts.push(hb)

  position = spec.end
})
// Add anything after the last spec
var after = specSource.substring(position, specSource.length)
parts.push(renderCommonmark(after))

// console.log(parts.join("\n"))

fs.writeFileSync(__dirname+'/../specification.html', parts.join("\n"))

